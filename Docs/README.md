# Golden AMI Payload - Script Standard

## Purpose
This repository provides Packer-ready payload scripts. Each script is idempotent, parameter-less, and communicates success or failure through a file-based contract. The Packer pipeline handles orchestration, retries, reboots, and log collection.

## Contract Summary (Mandatory)
### Environment Variables
All dynamic inputs are read from environment variables. Scripts do not accept parameters.

Global variables:
- `BUILD_LOG_DIR` (required): root directory for per-script logs and status.
- `LOCAL_BUILD_LOG_DIR` (optional): fallback root directory for local usage.
- `INSTALLER_CACHE_DIR` (required): cache directory for installer downloads.
- `PAYLOAD_TEST_MODE` (optional): `1` enables non-destructive test mode.

Installer argument placeholder:
- `*_INSTALLER_ARGS` must include `{INSTALLER_PATH}` when the installer path is required.

### Status File
Each script writes `status` (no extension) to:
- `$ENV:BUILD_LOG_DIR\<ScriptName>\status`

Contents:
- `0` for success
- `1` for failure

### Logging and Evidence
Each script creates:
- `install.log` for human-readable logs
- `validation.json` with a `Result` of `Pass`, `Fail`, or `NotApplicable`
- `reboot.required` when a reboot is needed (with a `RebootRequired` log entry)

### Idempotency
All scripts follow `CHECK -> ACTION -> VERIFY` and exit immediately with success when the component is already installed and correct.

### Reboot Signaling
If a reboot is required:
- The script writes `status = 0`
- Logs `RebootRequired`
- Exits with code `3010`

### SentinelOne Boundary
Scripts do not modify SentinelOne. Final validation only observes and reports state.

## Shared Modules
- `Modules/Common.psm1` for logging, status files, and shared utilities.
- `Modules/Validation.psm1` for validation result helpers.

## Script Environment Variables
### 7Zip-Install.ps1
- `SEVENZIP_INSTALLER_URL`
- `SEVENZIP_EXE_PATH`
- `SEVENZIP_INSTALLER_ARGS`
- `SEVENZIP_VERSION` (optional)

### AmazonCorretto8-Install.ps1
- `CORRETTO8_INSTALLER_URL`
- `CORRETTO8_JAVA_EXE_PATH`
- `CORRETTO8_INSTALLER_ARGS`
- `CORRETTO8_VERSION` (optional)

### DbVisualizer-Install.ps1
- `DBVISUALIZER_INSTALLER_URL`
- `DBVISUALIZER_INSTALL_DIR`
- `DBVISUALIZER_EXE_PATH`
- `DBVISUALIZER_INSTALLER_ARGS`
- `DBVISUALIZER_VERSION` (optional)

### NotepadPP-Install.ps1
- `NOTEPADPP_INSTALLER_URL`
- `NOTEPADPP_EXE_PATH`
- `NOTEPADPP_INSTALLER_ARGS`
- `NOTEPADPP_VERSION` (optional)

### SlikSubversion-Install.ps1
- `SLIKSVN_INSTALLER_URL`
- `SLIKSVN_EXE_PATH`
- `SLIKSVN_INSTALLER_ARGS`
- `SLIKSVN_VERSION` (optional)

## Final Validation and Manifest
`Final-Validation.ps1` aggregates results and writes:
- `build-manifest.json` at `$ENV:BUILD_LOG_DIR\build-manifest.json`

The manifest includes:
- Scripts executed
- Validation results per script
- Reboot occurrences
- SentinelOne state
- Build timestamp

## Local Test Harness
`Tools\Local-TestHarness.ps1` provides a non-destructive local run:
- Sets `BUILD_LOG_DIR` to `C:\Temp\BuildLogs`
- Enables `PAYLOAD_TEST_MODE=1`
- Populates required installer environment variables
- Runs each script twice to verify idempotency and contract output

Example usage:
- `powershell -ExecutionPolicy Bypass -File Tools\Local-TestHarness.ps1`

To perform real installs locally, use install mode (requires admin rights):
- `powershell -ExecutionPolicy Bypass -File Tools\Local-TestHarness.ps1 -Install`

In install mode, scripts still honor idempotency and will skip components that are already installed.

## Full VM Install (No Test Mode)
Use `Tools\Install-All.ps1` or `Tools\Install-All.bat` to install everything end-to-end.

Example usage:
- `powershell -ExecutionPolicy Bypass -File Tools\Install-All.ps1`
- `Tools\Install-All.bat`

To persist environment variables at the machine scope, use:
- `powershell -ExecutionPolicy Bypass -File Tools\Install-All.ps1 -PersistEnv`

To run automatically at startup (no interactive login required), create a scheduled task:
- `schtasks /Create /TN "GoldenAmiPayloadInstall" /SC ONSTART /RL HIGHEST /TR "powershell.exe -ExecutionPolicy Bypass -File C:\path\golden-ami-payload\Tools\Install-All.ps1" /F`

Review results under `BUILD_LOG_DIR` and the `build-manifest.json` generated by `Final-Validation.ps1`.
